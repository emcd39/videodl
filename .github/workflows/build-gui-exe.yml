name: Build and Release GUI EXE

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤© 00:00 (UTC æ—¶é—´ 16:00)
    - cron: "0 16 * * *"
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest  # ä½¿ç”¨ Windows çŽ¯å¢ƒæ‰“åŒ… Windows exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
      
      - name: Install videodl dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements_gui.txt
          pip install -e .
      
      - name: Verify videodl installation
        run: |
          python -c "import videodl; print(f'videodl version: {videodl.__version__}')"
          videodl --help
      
      - name: Build EXE with PyInstaller
        run: |
          pyinstaller --clean videodl_gui.spec
      
      - name: Verify EXE was created
        run: |
          if (Test-Path "dist\VideoDL_GUI.exe") {
            Write-Host "EXE file created successfully"
            Get-Item "dist\VideoDL_GUI.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "EXE file not found!"
            exit 1
          }
      
      - name: Create release info
        id: release_info
        run: |
          $version = python -c "import videodl; print(videodl.__version__)"
          $date = Get-Date -Format "yyyy-MM-dd"
          $tag = "v$version-gui-$date"
          $releaseName = "VideoDL GUI v$version ($date)"
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "releaseName=$releaseName" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.releaseName }}
          body: |
            ## VideoDL GUI è‡ªåŠ¨æž„å»º
            
            ### ðŸ“¦ æž„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.version }}
            - **æž„å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
            - **Python ç‰ˆæœ¬**: 3.13
            - **PyInstaller ç‰ˆæœ¬**: 6.18.0
            
            ### ðŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½ `VideoDL_GUI.exe` æ–‡ä»¶
            2. åŒå‡»è¿è¡Œå³å¯ï¼ˆæ— éœ€å®‰è£… Pythonï¼‰
            3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
            
            ### ðŸ“‹ åŠŸèƒ½ç‰¹æ€§
            - æ”¯æŒ 60+ è§†é¢‘å¹³å°è§£æž
            - CLI å­è¿›ç¨‹ä¸‹è½½ï¼Œæ˜¾ç¤ºå®žæ—¶è¿›åº¦
            - è‡ªå®šä¹‰ä¸‹è½½ç›®å½•
            - å…¨ä¸­æ–‡ç•Œé¢
            - è½»æ¾å–æ¶ˆä¸‹è½½ï¼ˆå…³é—­ CLI çª—å£ï¼‰
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ–‡ä»¶å¤§å°çº¦ 93 MBï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            - éœ€è¦ Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬
            - é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶è¯¯æŠ¥ï¼ˆæ­£å¸¸çŽ°è±¡ï¼‰
            
            ### ðŸ“ž æŠ€æœ¯æ”¯æŒ
            - GitHub: https://github.com/CharlesPikachu/videodl
            - é—®é¢˜åé¦ˆ: https://github.com/CharlesPikachu/videodl/issues
            
            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»º*
          files: |
            dist/VideoDL_GUI.exe
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VideoDL-GUI-EXE
          path: dist/VideoDL_GUI.exe
          retention-days: 30
      
      - name: Build summary
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **EXE æ–‡ä»¶**: dist/VideoDL_GUI.exe" >> $env:GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ ‡ç­¾**: ${{ steps.release_info.outputs.tag }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒåç§°**: ${{ steps.release_info.outputs.releaseName }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½é“¾æŽ¥" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ [Releases](https://github.com/CharlesPikachu/videodl/releases) é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ã€‚" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh
