name: Build and Release GUI EXE

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤© 00:00 (UTC æ—¶é—´ 16:00)
    - cron: "0 16 * * *"
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: windows-latest  # ä½¿ç”¨ Windows çŽ¯å¢ƒæ‰“åŒ… Windows exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
      
      - name: Install videodl dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements_gui.txt
          pip install -e .
      
      - name: Verify videodl installation
        run: |
          python -c "import videodl; print(f'videodl version: {videodl.__version__}')"
          videodl --help
      
      - name: Build EXE with PyInstaller
        run: |
          pyinstaller --clean videodl_gui.spec
      
      - name: Verify EXE was created
        run: |
          if (Test-Path "dist\VideoDL_GUI.exe") {
            Write-Host "EXE file created successfully"
            Get-Item "dist\VideoDL_GUI.exe" | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Error "EXE file not found!"
            exit 1
          }
      
      - name: Create release info
        id: release_info
        run: |
          $version = python -c "import videodl; print(videodl.__version__)"
          $date = Get-Date -Format "yyyy-MM-dd"
          $tag = "v$version-gui-$date"
          $releaseName = "VideoDL GUI v$version ($date)"
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "releaseName=$releaseName" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.releaseName }}
          body: |
            ## VideoDL GUI è‡ªåŠ¨æž„å»º
            
            ### ðŸ“¦ æž„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.version }}
            - **æž„å»ºæ—¥æœŸ**: ${{ github.event.head_commit.timestamp }}
            - **Python ç‰ˆæœ¬**: 3.13
            - **PyInstaller ç‰ˆæœ¬**: 6.18.0
            
            ### ðŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½ `VideoDL_GUI.exe` æ–‡ä»¶
            2. åŒå‡»è¿è¡Œå³å¯ï¼ˆæ— éœ€å®‰è£… Pythonï¼‰
            3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
            
            ### ðŸ“‹ åŠŸèƒ½ç‰¹æ€§
            - æ”¯æŒ 60+ è§†é¢‘å¹³å°è§£æž
            - CLI å­è¿›ç¨‹ä¸‹è½½ï¼Œæ˜¾ç¤ºå®žæ—¶è¿›åº¦
            - è‡ªå®šä¹‰ä¸‹è½½ç›®å½•
            - å…¨ä¸­æ–‡ç•Œé¢
            - è½»æ¾å–æ¶ˆä¸‹è½½ï¼ˆå…³é—­ CLI çª—å£ï¼‰
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ–‡ä»¶å¤§å°çº¦ 93 MBï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
            - éœ€è¦ Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬
            - é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶è¯¯æŠ¥ï¼ˆæ­£å¸¸çŽ°è±¡ï¼‰
            
            ### ï¿½ å¤–éƒ¨å·¥å…·ä¾èµ–
            
            **é‡è¦è¯´æ˜Ž**ï¼šæœ¬ exe æ–‡ä»¶æœ¬èº«ä¸åŒ…å«ä»¥ä¸‹å·¥å…·ï¼Œä½†æ ¹æ®ä½¿ç”¨åœºæ™¯å¯èƒ½éœ€è¦ï¼š
            
            #### âœ… åŸºæœ¬ä½¿ç”¨ï¼ˆæ— éœ€é¢å¤–å·¥å…·ï¼‰
            ä»¥ä¸‹å¹³å°**å®Œå…¨ä¸éœ€è¦**å®‰è£…ä»»ä½•é¢å¤–å·¥å…·ï¼š
            - ðŸ…±ï¸ å“”å“©å“”å“© (Bilibili)
            - ðŸŽµ æŠ–éŸ³ (Douyin)
            - ðŸ“± å¿«æ‰‹ (Kuaishou)
            - ðŸ“• å°çº¢ä¹¦ (Rednote)
            - ðŸ¦ å¾®åš (Weibo)
            - ä»¥åŠå¤§å¤šæ•°å…¶ä»–å¹³å°...
            
            #### ðŸ“¦ å¯é€‰å·¥å…·ï¼ˆæ ¹æ®éœ€è¦å®‰è£…ï¼‰
            
            **1. FFmpeg**ï¼ˆæŽ¨èå®‰è£…ï¼‰
            
            **ä½•æ—¶éœ€è¦**ï¼š
            - ä¸‹è½½ HLS/m3u8 æµåª’ä½“ï¼ˆæŸäº›å¹³å°çš„è§†é¢‘ï¼‰
            - åˆå¹¶è§†é¢‘å’ŒéŸ³é¢‘æµ
            - è½¬æ¢è§†é¢‘æ ¼å¼
            
            **å½±å“**ï¼š
            - âŒ æ— æ³•ä¸‹è½½æŸäº›å¹³å°çš„ HLS æµ
            - âŒ æ— æ³•ä¸‹è½½éœ€è¦åˆå¹¶çš„è§†é¢‘
            - âœ… å¤§éƒ¨åˆ†å¹³å°ï¼ˆBç«™ã€æŠ–éŸ³ã€å¿«æ‰‹ç­‰ï¼‰ä¸å—å½±å“
            
            **å®‰è£…æ–¹æ³•**ï¼š
            ```bash
            # Windows ç”¨æˆ·
            1. ä¸‹è½½ï¼šhttps://ffmpeg.org/download.html
            2. è§£åŽ‹åˆ°æŸä¸ªç›®å½•ï¼ˆå¦‚ C:\ffmpegï¼‰
            3. å°† C:\ffmpeg\bin æ·»åŠ åˆ°ç³»ç»Ÿ PATH
            4. éªŒè¯ï¼šffmpeg -version
            ```
            
            **2. N_m3u8DL-RE**ï¼ˆå¯é€‰ï¼Œå¢žå¼ºç‰ˆ FFmpegï¼‰
            
            **ä½•æ—¶éœ€è¦**ï¼š
            - ä¸‹è½½åŠ å¯†çš„ m3u8 æµ
            - ä¸‹è½½å—ä¿æŠ¤çš„ HLS è§†é¢‘
            - éœ€è¦æ›´å¿«çš„ä¸‹è½½é€Ÿåº¦ï¼ˆå¹¶è¡Œä¸‹è½½ï¼‰
            
            **å½±å“**ï¼š
            - âŒ æ— æ³•ä¸‹è½½æŸäº›åŠ å¯†è§†é¢‘
            - âœ… å¯ä»¥ç”¨ FFmpeg æ›¿ä»£ï¼ˆåŠŸèƒ½è¾ƒå¼±ï¼‰
            - âœ… å¤§éƒ¨åˆ†è§†é¢‘ä¸å—å½±å“
            
            **å®‰è£…æ–¹æ³•**ï¼š
            ```bash
            # Windows ç”¨æˆ·
            1. ä¸‹è½½ï¼šhttps://github.com/nilaoda/N_m3u8DL-RE/releases
            2. è§£åŽ‹åˆ°æŸä¸ªç›®å½•
            3. å°†ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ PATH
            4. éªŒè¯ï¼šN_m3u8DL-RE --version
            ```
            
            **3. Node.js**ï¼ˆä»…ç‰¹å®šå¹³å°ï¼‰
            
            **ä½•æ—¶éœ€è¦**ï¼š
            - ä¸‹è½½ YouTube è§†é¢‘
            - ä¸‹è½½ CCTV è§†é¢‘
            - ä¸‹è½½è…¾è®¯è§†é¢‘
            
            **å½±å“**ï¼š
            - âŒ è¿™ä¸‰ä¸ªå¹³å°æ— æ³•ä¸‹è½½
            - âœ… å…¶ä»–æ‰€æœ‰å¹³å°ï¼ˆBç«™ã€æŠ–éŸ³ã€å¿«æ‰‹ç­‰ï¼‰æ­£å¸¸
            
            **å®‰è£…æ–¹æ³•**ï¼š
            ```bash
            # Windows ç”¨æˆ·
            1. ä¸‹è½½ï¼šhttps://nodejs.org/
            2. å®‰è£…ï¼ˆä¼šè‡ªåŠ¨æ·»åŠ åˆ° PATHï¼‰
            3. éªŒè¯ï¼šnode -v
            ```
            
            #### ðŸ“Š ä½¿ç”¨åœºæ™¯å¿«é€Ÿå‚è€ƒ
            
            | ä½¿ç”¨åœºæ™¯ | æ˜¯å¦éœ€è¦ FFmpeg | æ˜¯å¦éœ€è¦ N_m3u8DL-RE | æ˜¯å¦éœ€è¦ Node.js |
            |---------|----------------|---------------------|----------------|
            | Bç«™ã€æŠ–éŸ³ã€å¿«æ‰‹ã€å°çº¢ä¹¦ç­‰ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ |
            | YouTube | âš ï¸ å¯é€‰ | âš ï¸ å¯é€‰ | âœ… **éœ€è¦** |
            | CCTV è§†é¢‘ | âœ… **éœ€è¦** | âš ï¸ å¯é€‰ | âœ… **éœ€è¦** |
            | è…¾è®¯è§†é¢‘ | âš ï¸ å¯é€‰ | âš ï¸ å¯é€‰ | âœ… **éœ€è¦** |
            | åŠ å¯† m3u8 è§†é¢‘ | âœ… **éœ€è¦** | âœ… **æŽ¨è** | âŒ ä¸éœ€è¦ |
            | æ™®é€š MP4 è§†é¢‘ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ |
            
            ### ï¿½ðŸ“ž æŠ€æœ¯æ”¯æŒ
            - GitHub: https://github.com/CharlesPikachu/videodl
            - é—®é¢˜åé¦ˆ: https://github.com/CharlesPikachu/videodl/issues
            
            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»º*
          files: |
            dist/VideoDL_GUI.exe
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VideoDL-GUI-EXE
          path: dist/VideoDL_GUI.exe
          retention-days: 30
      
      - name: Build summary
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **EXE æ–‡ä»¶**: dist/VideoDL_GUI.exe" >> $env:GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ ‡ç­¾**: ${{ steps.release_info.outputs.tag }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒåç§°**: ${{ steps.release_info.outputs.releaseName }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½é“¾æŽ¥" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ [Releases](https://github.com/CharlesPikachu/videodl/releases) é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ã€‚" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh
